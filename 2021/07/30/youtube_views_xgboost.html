<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>YouTube Views with XGBoost | Jacob Merrell</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="YouTube Views with XGBoost" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Predicting views using XGBoost and data from YouTube and Google APIs" />
<meta property="og:description" content="Predicting views using XGBoost and data from YouTube and Google APIs" />
<link rel="canonical" href="https://jmmerrell.github.io/ws/2021/07/30/youtube_views_xgboost.html" />
<meta property="og:url" content="https://jmmerrell.github.io/ws/2021/07/30/youtube_views_xgboost.html" />
<meta property="og:site_name" content="Jacob Merrell" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-30T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2021-07-30T00:00:00-05:00","url":"https://jmmerrell.github.io/ws/2021/07/30/youtube_views_xgboost.html","@type":"BlogPosting","headline":"YouTube Views with XGBoost","dateModified":"2021-07-30T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmmerrell.github.io/ws/2021/07/30/youtube_views_xgboost.html"},"description":"Predicting views using XGBoost and data from YouTube and Google APIs","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/ws/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmmerrell.github.io/ws/feed.xml" title="Jacob Merrell" /><link rel="shortcut icon" type="image/x-icon" href="/ws/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/ws/">Jacob Merrell</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/ws/about/">About Me</a><a class="page-link" href="/ws/search/">Search</a><a class="page-link" href="/ws/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">YouTube Views with XGBoost</h1><p class="page-description">Predicting views using XGBoost and data from YouTube and Google APIs</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-07-30T00:00:00-05:00" itemprop="datePublished">
        Jul 30, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      24 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/jmmerrell/ws/tree/master/_notebooks/2021-07-30-youtube_views_xgboost.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/ws/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/jmmerrell/ws/master?filepath=_notebooks%2F2021-07-30-youtube_views_xgboost.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/ws/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/jmmerrell/ws/blob/master/_notebooks/2021-07-30-youtube_views_xgboost.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/ws/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-07-30-youtube_views_xgboost.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/jmmerrell/ws/blob/master/images/youtube.jpg?raw=true" alt="kaggle_img000" /></p>
<p>I wanted to find the features that help me get more views on YouTube. Successfully identified which YouTube videos are successful with 85% accuracy. I used the YouTube API to gather data from my competitors on YouTube. I also used Google Vision's deep learning models to analyzye thumbnail images, and add that data to the YouTube API data. Data from nearly 2,000 videos was used to train and test an XGBoost model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>toc: true</li>
<li>badges: true</li>
<li>comments: true</li>
<li>categories: [XGBoost,YouTube,API,Google Vision]</li>
<li>image: images/youtube.jpg</li>
</ul>
<hr />

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Objective">1. Objective<a class="anchor-link" href="#1.-Objective"> </a></h2><p>We want to classify videos as succesful(high views per subscriber) or unsuccessful by scraping data from YouTube and using the data to train an XGBoost model. The main sources of data for this project are the APIs for YouTube and GoogleVision. From these two sources we gather information about each of my competitor's YouTube channels: views, subscribers, number of videos, titles of the videos, duration of each video, etc. From the YouTube API I also extract the thubnail URL for each video. Later I explain how the Google Vision API analyzes the image of the thumbnail for facial and text recognition. I combine the youtube data and the thumbnail data together for the analysis.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Import-the-necessary-libraries-and-data-set">2. Import the necessary libraries and data set<a class="anchor-link" href="#2.-Import-the-necessary-libraries-and-data-set"> </a></h2><h3 id="2.1.-Libraries">2.1. Libraries<a class="anchor-link" href="#2.1.-Libraries"> </a></h3><p>The libraries used in this project are the following.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">merre</span><span class="se">\\</span><span class="s2">Desktop</span><span class="se">\\</span><span class="s2">envs</span><span class="se">\\</span><span class="s2">yt_api_env</span><span class="se">\\</span><span class="s2">Lib</span><span class="se">\\</span><span class="s2">site-packages&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">numpy.core.fromnumeric</span> <span class="kn">import</span> <span class="n">shape</span>
<span class="kn">from</span> <span class="nn">numpy.lib.function_base</span> <span class="kn">import</span> <span class="n">diff</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">pandas.core.indexes.base</span> <span class="kn">import</span> <span class="n">Index</span>
<span class="kn">import</span> <span class="nn">emoji</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">fasttext</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span> 
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display_html</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span><span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span>
<span class="kn">import</span> <span class="nn">shap</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.2.-Data-Sets">2.2. Data Sets<a class="anchor-link" href="#2.2.-Data-Sets"> </a></h3><p>I merge together all the datasets taken from YouTube's API with the Google Vision API thumbnail image data. You can see the full code below for retreiving this data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">YouTube</span> <span class="n">API</span> <span class="n">Data</span> <span class="n">Pull</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">YTstats</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_id</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_statistics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">extract_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_statistics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_video_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_channel_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the channel statistics&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get channel statistics...&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://www.googleapis.com/youtube/v3/channels?part=statistics&amp;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_id</span><span class="si">}</span><span class="s1">&amp;key=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span>
        
        <span class="n">json_url</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_url</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;statistics&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not get channel statistics&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channel_statistics</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">get_channel_video_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="s2">&quot;Extract all video information of the channel&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get video data...&#39;</span><span class="p">)</span>
        <span class="n">channel_videos</span><span class="p">,</span> <span class="n">channel_playlists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_content</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;snippet&quot;</span><span class="p">,</span> <span class="s2">&quot;statistics&quot;</span><span class="p">,</span><span class="s2">&quot;contentDetails&quot;</span><span class="p">,</span> <span class="s2">&quot;topicDetails&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_videos</span><span class="p">))</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
       
        <span class="k">for</span> <span class="n">video_id</span> <span class="ow">in</span> <span class="n">channel_videos</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ii</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_videos</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_single_video_data</span><span class="p">(</span><span class="n">video_id</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
                <span class="n">channel_videos</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">video_data</span> <span class="o">=</span> <span class="n">channel_videos</span>
        <span class="k">return</span> <span class="n">channel_videos</span>

    <span class="k">def</span> <span class="nf">_get_single_video_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_id</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract further information for a single video</span>
<span class="sd">        parts can be: &#39;snippet&#39;, &#39;statistics&#39;, &#39;contentDetails&#39;, &#39;topicDetails&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.googleapis.com/youtube/v3/videos?part=</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">&amp;id=</span><span class="si">{</span><span class="n">video_id</span><span class="si">}</span><span class="s2">&amp;key=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">json_url</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_url</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">part</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error! Could not get </span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s1"> part of data: </span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_channel_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_all_pages</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all videos and playlists, can check all available search pages</span>
<span class="sd">        channel_videos = videoId: title, publishedAt</span>
<span class="sd">        channel_playlists = playlistId: title, publishedAt</span>
<span class="sd">        return channel_videos, channel_playlists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.googleapis.com/youtube/v3/search?key=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&amp;channelId=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_id</span><span class="si">}</span><span class="s2">&amp;part=snippet,id&amp;order=date&quot;</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s2">&quot;&amp;maxResults=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

        <span class="n">vid</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">npt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_content_per_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span><span class="p">(</span><span class="n">check_all_pages</span> <span class="ow">and</span> <span class="n">npt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">num_pages</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">nexturl</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;&amp;pageToken=&quot;</span> <span class="o">+</span> <span class="n">npt</span>
            <span class="n">next_vid</span><span class="p">,</span> <span class="n">next_pl</span><span class="p">,</span> <span class="n">npt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_content_per_page</span><span class="p">(</span><span class="n">nexturl</span><span class="p">)</span>
            <span class="n">vid</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">next_vid</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">next_pl</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">check_all_pages</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vid</span><span class="p">,</span> <span class="n">pl</span>

    <span class="k">def</span> <span class="nf">_get_channel_content_per_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all videos and playlists per page</span>
<span class="sd">        return channel_videos, channel_playlists, nextPageToken</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">json_url</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_url</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">channel_videos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">channel_playlists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error! Could not get correct channel data!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">channel_videos</span><span class="p">,</span> <span class="n">channel_playlists</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">global</span> <span class="n">num_pages</span>
        <span class="n">num_pages</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">nextPageToken</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nextPageToken&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">item_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
                <span class="n">published_at</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;snippet&#39;</span><span class="p">][</span><span class="s1">&#39;publishedAt&#39;</span><span class="p">]</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;snippet&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;youtube#video&#39;</span><span class="p">:</span>
                    <span class="n">video_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="s1">&#39;videoId&#39;</span><span class="p">]</span>
                    <span class="n">channel_videos</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;publishedAt&#39;</span><span class="p">:</span> <span class="n">published_at</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;youtube#playlist&#39;</span><span class="p">:</span>
                    <span class="n">playlist_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="s1">&#39;playlistId&#39;</span><span class="p">]</span>
                    <span class="n">channel_playlists</span><span class="p">[</span><span class="n">playlist_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;publishedAt&#39;</span><span class="p">:</span> <span class="n">published_at</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error! Could not extract data from item:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">channel_videos</span><span class="p">,</span> <span class="n">channel_playlists</span><span class="p">,</span> <span class="n">nextPageToken</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps channel statistics and video data in a single json file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_statistics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data is missing!</span><span class="se">\n</span><span class="s1">Call get_channel_statistics() and get_channel_video_data() first!&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">fused_data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_id</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;channel_statistics&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_statistics</span><span class="p">,</span>
                              <span class="s2">&quot;video_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_data</span><span class="p">}}</span>

        <span class="n">channel_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_data</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channelTitle&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_id</span><span class="p">)</span>
        <span class="n">channel_title</span> <span class="o">=</span> <span class="n">channel_title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">channel_title</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fused_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;file dumped to&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>


<span class="c1">#brian hull UCiNeUoUWfBLC8mJuMzI6hvw</span>
<span class="c1">#Black Gryphon UCvzWGXYFDiiJ338KIJPhbhQ </span>
<span class="c1">#Brock Baker  UCLzdMXE3R2xXIklfIO9HCcQ</span>
<span class="c1"># Ori  UCra3g9Qvmgux0NyY2Pdj4Lw</span>
<span class="c1"># Scheiffer Bates   UCcBacTJIf67LSU_-yeJwDvg</span>
<span class="c1">#Azerrz  UCiwIAU4SNlrcv47504JrJeQ</span>
<span class="c1">#Danny padilla &amp; mason sperling  UCfhK8MfxO-9RCypkLDyW1rw</span>
<span class="c1"># Brizzy UC7lObFRyZgoZcMYHHqxi9lg</span>
<span class="c1"># Redfireball UC88CnZTYFz5ugp-JtDEQ3-g</span>
<span class="c1"># Sounds like pizza  UCh6OfzCefcCGFfihPbe_Y4g</span>
<span class="c1">#joshiiwuh  UCxRGk49YNiW3Cq8s7MGknqw</span>
<span class="c1"># simau UCkXvCWJjAqNcFwxF7hW_ZRQ</span>
<span class="c1">#Knep UCy7gv-FM-dMvw6dMtj8Qfgg</span>
<span class="c1"># charlie hopkinson  UCewLMcro9tNP97XQ1rxtLXQ</span>
<span class="c1">#Uss JA doin  UCqPYUMNbVeEhyTBIZCDO_VQ</span>
<span class="c1"># Shanieology  UCR93YdwZ4UKEUwf1gA-ZusA</span>
<span class="c1"># BigShade  UC7Wt6Nukmt83Bph3us5s5Aw</span>
<span class="c1"># Best in Class  UClQhFMEVUxJAwMW-KdZ0SvQ</span>
<span class="c1"># Daniel Ferguson  UCXFzOJmXVaP1tMLiww4aQzg</span>
<span class="c1"># Mikey Boltz  UC0gXT2T6KtmV0IHNNNvruAQ</span>
<span class="c1"># Maxamili  UC-0WjH-efG2qvNlZUBlX70Q</span>




<span class="n">api_key</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;YT_API&#39;</span><span class="p">)</span>

<span class="c1"># channel_ids= [&#39;UCiNeUoUWfBLC8mJuMzI6hvw&#39;,&#39;UCvzWGXYFDiiJ338KIJPhbhQ&#39;,&#39;UCLzdMXE3R2xXIklfIO9HCcQ&#39;,&#39;UCra3g9Qvmgux0NyY2Pdj4Lw&#39;,&#39;UCcBacTJIf67LSU_-yeJwDvg&#39;,</span>
<span class="c1"># &#39;UCiwIAU4SNlrcv47504JrJeQ&#39;,&#39;UCfhK8MfxO-9RCypkLDyW1rw&#39;,&#39;UC7lObFRyZgoZcMYHHqxi9lg&#39;,&#39;UC88CnZTYFz5ugp-JtDEQ3-g&#39;,&#39;UCh6OfzCefcCGFfihPbe_Y4g&#39;,</span>
<span class="c1"># &#39;UCxRGk49YNiW3Cq8s7MGknqw&#39;,&#39;UCkXvCWJjAqNcFwxF7hW_ZRQ&#39;,&#39;UCy7gv-FM-dMvw6dMtj8Qfgg&#39;,&#39;UCewLMcro9tNP97XQ1rxtLXQ&#39;,&#39;UCqPYUMNbVeEhyTBIZCDO_VQ&#39;,</span>
<span class="c1"># &#39;UCR93YdwZ4UKEUwf1gA-ZusA&#39;,&#39;UC7Wt6Nukmt83Bph3us5s5Aw&#39;,&#39;UClQhFMEVUxJAwMW-KdZ0SvQ&#39;,&#39;UCXFzOJmXVaP1tMLiww4aQzg&#39;,&#39;UC0gXT2T6KtmV0IHNNNvruAQ&#39;,</span>
<span class="c1"># &#39;UC-0WjH-efG2qvNlZUBlX70Q&#39;]</span>

<span class="n">channel_ids</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;UC-0WjH-efG2qvNlZUBlX70Q&#39;</span><span class="p">,</span><span class="s1">&#39;UClQhFMEVUxJAwMW-KdZ0SvQ&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">channel_ids</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">num_pages</span>
    <span class="n">num_pages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">YTstats</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span><span class="n">channel_id</span><span class="p">)</span>
    <span class="n">yt</span><span class="o">.</span><span class="n">get_channel_statistics</span><span class="p">()</span>
    <span class="n">yt</span><span class="o">.</span><span class="n">get_channel_video_data</span><span class="p">()</span>
    <span class="n">yt</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Convert</span> <span class="n">JSON</span> <span class="n">to</span> <span class="n">Pandas</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">replace</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1">#C:/Users/merre/Desktop/data projects/</span>
<span class="n">files</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shanieology.json&quot;</span><span class="p">,</span><span class="s2">&quot;simau.json&quot;</span><span class="p">,</span><span class="s2">&quot;soundslikepizza.json&quot;</span><span class="p">,</span><span class="s2">&quot;azerrz.json&quot;</span><span class="p">,</span><span class="s2">&quot;BigShade.json&quot;</span><span class="p">,</span><span class="s2">&quot;black_gryph0n.json&quot;</span>
<span class="p">,</span><span class="s2">&quot;brian_hull.json&quot;</span><span class="p">,</span><span class="s2">&quot;brizzy_voices.json&quot;</span><span class="p">,</span><span class="s2">&quot;brock_baker.json&quot;</span><span class="p">,</span><span class="s2">&quot;charlie_hopkinson.json&quot;</span><span class="p">,</span><span class="s2">&quot;danny_padilla_&amp;_mason_sperling.json&quot;</span>
<span class="p">,</span><span class="s2">&quot;ja_doin_stuff.json&quot;</span><span class="p">,</span><span class="s2">&quot;joshiiwuh.json&quot;</span><span class="p">,</span><span class="s2">&quot;knep.json&quot;</span><span class="p">,</span><span class="s2">&quot;ori.json&quot;</span><span class="p">,</span><span class="s2">&quot;redfireball555.json&quot;</span><span class="p">,</span><span class="s2">&quot;scheiffer_bates.json&quot;</span><span class="p">,</span><span class="s2">&quot;daniel_ferguson.json&quot;</span><span class="p">,</span>
<span class="s2">&quot;BigShade.json&quot;</span><span class="p">,</span><span class="s2">&quot;best_in_class.json&quot;</span><span class="p">,</span><span class="s2">&quot;maxamili.json&quot;</span><span class="p">,</span><span class="s2">&quot;mikey_bolts.json&quot;</span><span class="p">]</span>

<span class="n">data</span><span class="o">=</span><span class="kc">None</span>
<span class="n">df_channel_new</span><span class="o">=</span><span class="kc">None</span>
<span class="n">df_channel</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">channel_id</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
    <span class="n">channel_stats</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;channel_statistics&quot;</span><span class="p">]</span>
    <span class="n">video_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;video_data&quot;</span><span class="p">]</span>
    <span class="n">channel_views</span><span class="o">=</span> <span class="n">channel_stats</span><span class="p">[</span><span class="s2">&quot;viewCount&quot;</span><span class="p">]</span>
    <span class="n">channel_subs</span><span class="o">=</span> <span class="n">channel_stats</span><span class="p">[</span><span class="s2">&quot;subscriberCount&quot;</span><span class="p">]</span>
    <span class="n">channel_videos</span><span class="o">=</span> <span class="n">channel_stats</span><span class="p">[</span><span class="s2">&quot;videoCount&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sorted_vids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">video_stats</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;viewCount&quot;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">sorted_vids</span> <span class="o">=</span> <span class="n">video_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">sorted_vids</span><span class="p">:</span>
        <span class="n">video_id</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="n">title_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">title_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="n">words</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">upper_words</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">title_words</span><span class="p">:</span>
            <span class="n">words</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="n">upper_words</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">upper_pct</span> <span class="o">=</span> <span class="n">upper_words</span><span class="o">/</span><span class="n">words</span>
        
        <span class="n">emoji_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;[</span><span class="se">\U0001f600</span><span class="s1">-</span><span class="se">\U0001f650</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">))</span>
        
        <span class="c1">#Convert time to Mexico City Time</span>
        <span class="n">upload_date_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;publishedAt&quot;</span><span class="p">],</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">upload_date</span> <span class="o">=</span> <span class="n">upload_date_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">upload_time</span> <span class="o">=</span> <span class="n">upload_date_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#0 is Monday, 6 is Sunday</span>
        <span class="n">upload_day</span> <span class="o">=</span> <span class="n">upload_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;04:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">upload_time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;10:30:00&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="n">upload_time_of_day</span> <span class="o">=</span> <span class="s1">&#39;morning&#39;</span>
        <span class="k">elif</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;10:30:01&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">upload_time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;18:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="n">upload_time_of_day</span> <span class="o">=</span> <span class="s1">&#39;afternoon&#39;</span>
        <span class="k">elif</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;18:00:01&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">upload_time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;23:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="n">upload_time_of_day</span> <span class="o">=</span> <span class="s1">&#39;night&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upload_time_of_day</span> <span class="o">=</span> <span class="s2">&quot;late_night&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;maxres&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="n">thumbnail_h</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;maxres&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
            <span class="n">thumbnail_w</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;maxres&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                <span class="n">thumbnail_h</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
                <span class="n">thumbnail_w</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thumbnail_url</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                    <span class="n">thumbnail_h</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
                    <span class="n">thumbnail_w</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;thumbnails&quot;</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>  
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">thumbnail_url</span><span class="o">=</span><span class="kc">None</span>
                    <span class="n">thumbnail_h</span><span class="o">=</span><span class="kc">None</span>
                    <span class="n">thumbnail_w</span><span class="o">=</span><span class="kc">None</span>                  
        <span class="k">try</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;channelTitle&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">channel</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">num_tags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">categoryId</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;categoryId&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">categoryId</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">liveBroadcastContent</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;liveBroadcastContent&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">liveBroadcastContent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">defaultAudioLanguage</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;defaultAudioLanguage&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">defaultAudioLanguage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">viewCount</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;viewCount&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">viewCount</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">likeCount</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;likeCount&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">likeCount</span> <span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dislikeCount</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;dislikeCount&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dislikeCount</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">favoriteCount</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;favoriteCount&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">favoriteCount</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">commentCount</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;commentCount&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">commentCount</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">duration0</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">duration0</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+H&#39;</span><span class="p">,</span><span class="n">duration0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+M&#39;</span><span class="p">,</span><span class="n">duration0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mins</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+S&#39;</span><span class="p">,</span><span class="n">duration0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">secs</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">hours</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">hours</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">+</span> <span class="n">secs</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">elif</span> <span class="n">mins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">mins</span> <span class="o">+</span> <span class="n">secs</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">elif</span> <span class="n">secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">secs</span><span class="o">/</span><span class="mi">60</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;definition&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">captions</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;caption&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">captions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>    
            <span class="n">licensedContent</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;licensedContent&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">licensedContent</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topicCategories</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;topicCategories&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">topicCategories</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">video_id</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">video_id</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">title_len</span><span class="p">,</span><span class="n">words</span><span class="p">,</span><span class="n">upper_pct</span><span class="p">,</span><span class="n">emoji_count</span><span class="p">,</span><span class="n">upload_date</span><span class="p">,</span><span class="n">upload_time</span><span class="p">,</span><span class="n">upload_day</span><span class="p">,</span><span class="n">upload_time_of_day</span><span class="p">,</span><span class="n">viewCount</span><span class="p">,</span><span class="n">likeCount</span><span class="p">,</span><span class="n">dislikeCount</span><span class="p">,</span><span class="n">favoriteCount</span><span class="p">,</span>
        <span class="n">commentCount</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">definition</span><span class="p">,</span><span class="n">captions</span><span class="p">,</span><span class="n">licensedContent</span><span class="p">,</span><span class="n">thumbnail_url</span><span class="p">,</span> <span class="n">thumbnail_w</span><span class="p">,</span> <span class="n">thumbnail_h</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span><span class="n">num_tags</span><span class="p">,</span><span class="n">categoryId</span><span class="p">,</span><span class="n">liveBroadcastContent</span><span class="p">,</span>
        <span class="n">defaultAudioLanguage</span><span class="p">,</span><span class="n">topicCategories</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel_subs</span><span class="p">,</span> <span class="n">channel_views</span><span class="p">,</span> <span class="n">channel_videos</span><span class="p">,</span><span class="n">desc</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;title_len&#39;</span><span class="p">,</span><span class="s1">&#39;words&#39;</span><span class="p">,</span><span class="s1">&#39;upper_pct&#39;</span><span class="p">,</span><span class="s1">&#39;emoji_count&#39;</span><span class="p">,</span><span class="s1">&#39;upload_date&#39;</span><span class="p">,</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span><span class="s1">&#39;upload_day&#39;</span><span class="p">,</span><span class="s1">&#39;upload_time_of_day&#39;</span><span class="p">,</span><span class="s1">&#39;viewCount&#39;</span><span class="p">,</span><span class="s1">&#39;likeCount&#39;</span><span class="p">,</span><span class="s1">&#39;dislikeCount&#39;</span><span class="p">,</span>
    <span class="s1">&#39;favoriteCount&#39;</span><span class="p">,</span><span class="s1">&#39;commentCount&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;definition&#39;</span><span class="p">,</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span><span class="s1">&#39;licensedContent&#39;</span><span class="p">,</span><span class="s1">&#39;thumbnail_url&#39;</span><span class="p">,</span> <span class="s1">&#39;thumbnail_w&#39;</span><span class="p">,</span> <span class="s1">&#39;thumbnail_h&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span><span class="s1">&#39;num_tags&#39;</span><span class="p">,</span>
    <span class="s1">&#39;categoryId&#39;</span><span class="p">,</span><span class="s1">&#39;liveBroadcastContent&#39;</span><span class="p">,</span><span class="s1">&#39;defaultAudioLanguage&#39;</span><span class="p">,</span><span class="s1">&#39;topicCategories&#39;</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_subs&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_views&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_videos&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span><span class="s1">&#39;txt&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Functions</span> <span class="n">to</span> <span class="n">Query</span> <span class="n">Google</span> <span class="n">Vision</span> <span class="n">API</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">googleapiclient</span> <span class="kn">import</span> <span class="n">discovery</span>
<span class="kn">from</span> <span class="nn">oauth2client</span> <span class="kn">import</span> <span class="n">tools</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">client</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># limited preview only (sorry!) </span>
<span class="n">API_DISCOVERY_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_VISION_API&#39;</span><span class="p">)</span>



<span class="sd">&quot;&quot;&quot; Google Authentication Utilities &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">get_vision_api</span><span class="p">():</span>
	<span class="n">credentials</span> <span class="o">=</span> <span class="n">get_api_credentials</span><span class="p">(</span><span class="s1">&#39;https://www.googleapis.com/auth/cloud-platform&#39;</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">API_DISCOVERY_FILE</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">doc</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>	
	<span class="k">return</span> <span class="n">discovery</span><span class="o">.</span><span class="n">build_from_document</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span> <span class="n">http</span><span class="o">=</span><span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">get_api_credentials</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">service_account</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Build API client based on oAuth2 authentication &quot;&quot;&quot;</span>
	<span class="c1"># STORAGE = file.Storage(os.environ.get(&#39;GOOGLE_VISION_API&#39;)) #local storage of oAuth tokens</span>
	<span class="n">STORAGE</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">Storage</span><span class="p">(</span><span class="n">API_DISCOVERY_FILE</span><span class="p">)</span> <span class="c1">#local storage of oAuth tokens</span>
	<span class="n">credentials</span> <span class="o">=</span> <span class="n">STORAGE</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">credentials</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">credentials</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span> <span class="c1">#check if new oAuth flow is needed</span>
		<span class="k">if</span> <span class="n">service_account</span><span class="p">:</span> <span class="c1">#server 2 server flow</span>
			<span class="c1"># with open(os.environ.get(&#39;GOOGLE_VISION_API&#39;)) as f:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">API_DISCOVERY_FILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">account</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
				<span class="n">email</span> <span class="o">=</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;client_email&#39;</span><span class="p">]</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;private_key&#39;</span><span class="p">]</span>
			<span class="n">credentials</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">SignedJwtAssertionCredentials</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
			<span class="n">STORAGE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1">#normal oAuth2 flow</span>
			<span class="n">CLIENT_SECRETS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;client_secrets.json&#39;</span><span class="p">)</span>
			<span class="n">FLOW</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">flow_from_clientsecrets</span><span class="p">(</span><span class="n">CLIENT_SECRETS</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
			<span class="n">PARSER</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">tools</span><span class="o">.</span><span class="n">argparser</span><span class="p">])</span>
			<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
			<span class="n">credentials</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">run_flow</span><span class="p">(</span><span class="n">FLOW</span><span class="p">,</span> <span class="n">STORAGE</span><span class="p">,</span> <span class="n">FLAGS</span><span class="p">)</span>
		
	<span class="k">return</span> <span class="n">credentials</span>


<span class="sd">&quot;&quot;&quot; read/write utilities &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">read_image</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
	<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_image_base64</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>


<span class="sd">&quot;&quot;&quot; OpenCV drawing utilities &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">draw_face</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
	<span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;detectionConfidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">4</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">tl_</span><span class="p">,</span><span class="n">br_</span> <span class="o">=</span> <span class="n">draw_box</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;fdBoundingPoly&#39;</span><span class="p">][</span><span class="s1">&#39;vertices&#39;</span><span class="p">])</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">tl_</span><span class="p">,</span><span class="n">br_</span><span class="o">=</span><span class="kc">None</span>

			<span class="k">try</span><span class="p">:</span>
				<span class="n">joy</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;joyLikelihood&#39;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">joy</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">sad</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;sorrowLikelihood&#39;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">sad</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">angry</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;angerLikelihood&#39;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">angry</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">suprise</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;surpriseLikelihood&#39;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">suprise</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

			<span class="n">emotions</span><span class="o">=</span><span class="p">[</span><span class="n">joy</span><span class="p">,</span><span class="n">sad</span><span class="p">,</span><span class="n">angry</span><span class="p">,</span><span class="n">suprise</span><span class="p">]</span>

			<span class="k">if</span> <span class="s1">&#39;VERY_LIKELY&#39;</span> <span class="ow">in</span> <span class="n">emotions</span><span class="p">:</span>
				<span class="n">emotion</span> <span class="o">=</span> <span class="n">emotions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;VERY_LIKELY&#39;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="s1">&#39;LIKELY&#39;</span> <span class="ow">in</span> <span class="n">emotions</span><span class="p">:</span>
				<span class="n">emotion</span> <span class="o">=</span> <span class="n">emotions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;LIKELY&#39;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="s1">&#39;POSSIBLE&#39;</span> <span class="ow">in</span> <span class="n">emotions</span><span class="p">:</span>
				<span class="n">emotion</span> <span class="o">=</span> <span class="n">emotions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;POSSIBLE&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">emotion</span><span class="o">=</span><span class="kc">None</span>
			
			<span class="k">if</span> <span class="n">emotion</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
				<span class="n">text</span><span class="o">=</span> <span class="s2">&quot;happy&quot;</span>
			<span class="k">elif</span> <span class="n">emotion</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="n">text</span><span class="o">=</span><span class="s2">&quot;sad&quot;</span>
			<span class="k">elif</span> <span class="n">emotion</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
				<span class="n">text</span><span class="o">=</span><span class="s2">&quot;angry&quot;</span>
			<span class="k">elif</span> <span class="n">emotion</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
				<span class="n">text</span><span class="o">=</span><span class="s2">&quot;suprised&quot;</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">text</span><span class="o">=</span><span class="s2">&quot;other&quot;</span>
			<span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tl_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">draw_text</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">text</span> <span class="p">,</span><span class="n">tl_</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;landmarks&#39;</span><span class="p">]:</span>
					<span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">draw_point</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">landmark</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>
						<span class="k">except</span><span class="p">:</span>
							<span class="k">pass</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span>
	<span class="k">return</span> <span class="n">faces</span>	


<span class="k">def</span> <span class="nf">extract_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Extract two opposite vertices from a list of 4 (assumption: rectangle) &quot;&quot;&quot;</span>

	<span class="n">min_x</span><span class="p">,</span><span class="n">max_x</span><span class="p">,</span><span class="n">min_y</span><span class="p">,</span><span class="n">max_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">min_y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_x</span><span class="p">:</span>
			<span class="n">min_x</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">max_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_x</span><span class="p">:</span>
			<span class="n">max_x</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">min_y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_y</span><span class="p">:</span>
			<span class="n">min_y</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">max_y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span>
			<span class="n">max_y</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_x</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_y</span><span class="p">)</span>
		<span class="n">v2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_x</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_y</span><span class="p">)</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="n">v1</span><span class="o">=</span><span class="kc">None</span>
		<span class="n">v2</span><span class="o">=</span><span class="kc">None</span>

	<span class="k">return</span> <span class="n">v1</span><span class="p">,</span><span class="n">v2</span>


<span class="k">def</span> <span class="nf">draw_box</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>
	<span class="n">v1</span><span class="p">,</span><span class="n">v2</span> <span class="o">=</span> <span class="n">extract_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">pt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">pt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="n">thickness</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="n">pt1</span><span class="o">=</span><span class="kc">None</span>
		<span class="n">pt2</span><span class="o">=</span><span class="kc">None</span>
	<span class="k">return</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span>

<span class="k">def</span> <span class="nf">draw_point</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
	<span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">pt</span>

<span class="k">def</span> <span class="nf">draw_text</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span><span class="n">loc</span><span class="p">):</span>
	<span class="n">font_face</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
	<span class="c1">#thickness = 1</span>
	<span class="n">thickness</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mf">0.002</span> <span class="o">*</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>
	<span class="c1"># for scale in np.arange(20,0,-0.2):</span>
	<span class="c1"># 	(w,h),baseline = cv2.getTextSize(text, font_face, scale, thickness)</span>
	<span class="c1"># 	if w &lt;= im.shape[1]:</span>
	<span class="c1"># 		new_img = cv2.copyMakeBorder(im, 0, baseline*4, 0, 0, cv2.BORDER_CONSTANT, value=0)</span>
	<span class="c1"># 		cv2.putText(new_img, text, (baseline*2 +20 ,new_img.shape[0]-baseline +20 ), font_face, 2, (255,255,255), thickness)</span>
	<span class="c1"># 		return new_img</span>
	<span class="n">new_img</span> <span class="o">=</span> <span class="n">im</span>
	<span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">new_img</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">font_face</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">102</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">new_img</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Google</span> <span class="n">Vision</span> <span class="n">API</span> <span class="n">Data</span> <span class="n">Pull</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">webbrowser</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">google.cloud.vision_v1.types.image_annotator</span> <span class="kn">import</span> <span class="n">AnnotateImageRequest</span><span class="p">,</span> <span class="n">AnnotateImageResponse</span>
<span class="kn">from</span> <span class="nn">numpy.core.fromnumeric</span> <span class="kn">import</span> <span class="n">shape</span>
<span class="kn">from</span> <span class="nn">numpy.core.numeric</span> <span class="kn">import</span> <span class="n">NaN</span>
<span class="kn">from</span> <span class="nn">numpy.lib.arraysetops</span> <span class="kn">import</span> <span class="n">unique</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">dtype</span>
<span class="kn">from</span> <span class="nn">functions_for_google_vision_api</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_vision_api</span><span class="p">,</span> <span class="n">read_image</span><span class="p">,</span> <span class="n">read_image_base64</span><span class="p">,</span> <span class="n">save_image</span><span class="p">,</span> <span class="n">draw_face</span><span class="p">,</span> <span class="n">draw_box</span><span class="p">,</span> <span class="n">draw_text</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">vision_v1</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">vision</span>
<span class="kn">from</span> <span class="nn">google.cloud.vision_v1</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1">#####################################################################</span>

<span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">from</span> <span class="nn">googleapiclient</span> <span class="kn">import</span> <span class="n">discovery</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">GoogleCredentials</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GOOGLE_APPLICATION_CREDENTIALS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_VISION_API&#39;</span><span class="p">)</span>

<span class="n">DISCOVERY_URL</span><span class="o">=</span><span class="s1">&#39;https://</span><span class="si">{api}</span><span class="s1">.googleapis.com/$discovery/rest?version=</span><span class="si">{apiVersion}</span><span class="s1">&#39;</span>

<span class="k">def</span> <span class="nf">get_vision_service</span><span class="p">():</span>
	<span class="n">credentials</span> <span class="o">=</span> <span class="n">GoogleCredentials</span><span class="o">.</span><span class="n">get_application_default</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">discovery</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span> <span class="n">discoveryServiceUrl</span> <span class="o">=</span> <span class="n">DISCOVERY_URL</span><span class="p">)</span>
	

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">video_id</span><span class="p">,</span> <span class="n">inputfile</span><span class="p">):</span>
	<span class="n">service</span> <span class="o">=</span> <span class="n">get_vision_service</span><span class="p">()</span>
	<span class="n">outputfile</span><span class="o">=</span> <span class="s2">&quot;C:/Users/merre/Desktop/ws/data/youtube_jadoinstuff/output_images/thumbnail_&quot;</span> <span class="o">+</span><span class="n">inputfile</span><span class="p">[</span><span class="n">inputfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">inputfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>

	<span class="n">batch_request</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;maxResults&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FACE_DETECTION&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;maxResults&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LABEL_DETECTION&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;maxResults&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SAFE_SEARCH_DETECTION&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;maxResults&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT_DETECTION&quot;</span>
        <span class="p">}</span>
      <span class="p">],</span>
		<span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="s2">&quot;imageUri&quot;</span><span class="p">:</span> <span class="n">inputfile</span>
				<span class="p">}</span>
			<span class="p">}</span>
    <span class="p">}</span>
	<span class="p">]</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">images</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">{</span>
		<span class="s1">&#39;requests&#39;</span><span class="p">:</span> <span class="n">batch_request</span><span class="p">,</span>
		<span class="p">})</span>
	<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
	<span class="n">inputfile</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">faces</span><span class="p">,</span><span class="n">texts</span><span class="p">,</span><span class="n">adult</span><span class="p">,</span><span class="n">medical</span><span class="p">,</span><span class="n">racy</span><span class="p">,</span><span class="n">spoof</span><span class="p">,</span><span class="n">violence</span> <span class="o">=</span> <span class="n">show_results</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">)</span>
	<span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">video_id</span><span class="p">,</span><span class="n">inputfile</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">faces</span><span class="p">,</span><span class="n">texts</span><span class="p">,</span><span class="n">adult</span><span class="p">,</span><span class="n">medical</span><span class="p">,</span><span class="n">racy</span><span class="p">,</span><span class="n">spoof</span><span class="p">,</span><span class="n">violence</span><span class="p">]</span>
	<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
	<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_list</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="n">vars_list</span>


<span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">):</span>

	<span class="c1">#read original file</span>
	<span class="n">im</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

	<span class="c1">#draw face, boxes and text for each response</span>
	<span class="n">faces</span><span class="o">=</span><span class="p">[]</span>
	<span class="n">labels</span><span class="o">=</span><span class="p">[]</span>
	<span class="n">texts</span><span class="o">=</span><span class="p">[]</span>
	<span class="c1">#dict_keys = data.keys()</span>
	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;responses&#39;</span><span class="p">]:</span>
		
		<span class="k">if</span> <span class="s1">&#39;faceAnnotations&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
			<span class="n">faces</span> <span class="o">=</span> <span class="n">draw_face</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;faceAnnotations&#39;</span><span class="p">])</span>
		
		<span class="k">if</span> <span class="s1">&#39;labelAnnotations&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;labelAnnotations&#39;</span><span class="p">]:</span>
				<span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">6</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
					<span class="k">except</span><span class="p">:</span>
						<span class="n">labels</span><span class="o">=</span><span class="n">labels</span>
		
		<span class="k">if</span> <span class="s1">&#39;textAnnotations&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;textAnnotations&#39;</span><span class="p">]:</span>
				<span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
					<span class="k">except</span><span class="p">:</span>
						<span class="n">texts</span><span class="o">=</span><span class="n">texts</span>
		
		<span class="k">if</span> <span class="s1">&#39;safeSearchAnnotation&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">adult</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;safeSearchAnnotation&#39;</span><span class="p">][</span><span class="s2">&quot;adult&quot;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">adult</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">medical</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;safeSearchAnnotation&#39;</span><span class="p">][</span><span class="s2">&quot;medical&quot;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">medical</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">racy</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;safeSearchAnnotation&#39;</span><span class="p">][</span><span class="s2">&quot;racy&quot;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">racy</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>	
				<span class="n">spoof</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;safeSearchAnnotation&#39;</span><span class="p">][</span><span class="s2">&quot;spoof&quot;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">spoof</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">violence</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;safeSearchAnnotation&#39;</span><span class="p">][</span><span class="s2">&quot;violence&quot;</span><span class="p">]</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">violence</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
	
	<span class="n">labels</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
	<span class="n">texts</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
		<span class="c1">#save to output file</span>
	<span class="n">save_image</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">inputfile</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">faces</span><span class="p">,</span><span class="n">texts</span><span class="p">,</span><span class="n">adult</span><span class="p">,</span><span class="n">medical</span><span class="p">,</span><span class="n">racy</span><span class="p">,</span><span class="n">spoof</span><span class="p">,</span><span class="n">violence</span>

<span class="c1"># files= [&quot;shanieology.txt&quot;,&quot;simau.txt&quot;,&quot;soundslikepizza.txt&quot;,&quot;azerrz.txt&quot;,&quot;BigShade.txt&quot;,&quot;black_gryph0n.txt&quot;</span>
<span class="c1"># ,&quot;brian_hull.txt&quot;,&quot;brizzy_voices.txt&quot;,&quot;brock_baker.txt&quot;,&quot;charlie_hopkinson.txt&quot;,&quot;danny_padilla_&amp;_mason_sperling.txt&quot;</span>
<span class="c1"># ,&quot;ja_doin_stuff.txt&quot;,&quot;joshiiwuh.txt&quot;,&quot;knep.txt&quot;,&quot;ori.txt&quot;,&quot;redfireball555.txt&quot;,&quot;scheiffer_bates.txt&quot;,&quot;daniel_ferguson.txt&quot;,</span>
<span class="c1"># &quot;BigShade.txt&quot;,&quot;best_in_class.txt&quot;,&quot;maxamili.txt&quot;,&quot;mikey_bolts.txt&quot;]</span>
<span class="n">files</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;daniel_ferguson.txt&quot;</span><span class="p">,</span><span class="s2">&quot;BigShade.txt&quot;</span><span class="p">,</span><span class="s2">&quot;best_in_class.txt&quot;</span><span class="p">,</span><span class="s2">&quot;maxamili.txt&quot;</span><span class="p">,</span><span class="s2">&quot;mikey_bolts.txt&quot;</span><span class="p">]</span>

<span class="n">vid_ids</span><span class="o">=</span><span class="p">[]</span>
<span class="n">vid_thumb_urls</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	<span class="n">videos_loop</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
	<span class="n">vid_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">videos_loop</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">videos_loop</span><span class="p">[</span><span class="s2">&quot;upload_date&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)][</span><span class="s2">&quot;video_id&quot;</span><span class="p">]))</span>
	<span class="n">vid_thumb_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">videos_loop</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">videos_loop</span><span class="p">[</span><span class="s2">&quot;upload_date&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)][</span><span class="s2">&quot;thumbnail_url&quot;</span><span class="p">]))</span>
	
<span class="n">vid_ids</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">vid_ids</span><span class="p">))</span>
<span class="n">vid_thumb_urls</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">vid_thumb_urls</span><span class="p">))</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span><span class="s1">&#39;thumbnail_url&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span><span class="s1">&#39;faces&#39;</span><span class="p">,</span><span class="s1">&#39;texts&#39;</span><span class="p">,</span><span class="s1">&#39;adult&#39;</span><span class="p">,</span><span class="s1">&#39;medical&#39;</span><span class="p">,</span><span class="s1">&#39;racy&#39;</span><span class="p">,</span><span class="s1">&#39;spoof&#39;</span><span class="p">,</span><span class="s1">&#39;violence&#39;</span><span class="p">])</span>
<span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vid_ids</span><span class="p">)):</span>
	<span class="k">if</span> <span class="n">vid_thumb_urls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NaN</span><span class="p">:</span>
		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">video_id</span><span class="o">=</span><span class="n">vid_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">inputfile</span><span class="o">=</span><span class="n">vid_thumb_urls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="mi">30</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">vid_ids</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">vid_ids</span><span class="p">):</span>
			<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;thumbnail_data_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num videos&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;---- Percent complete:&quot;</span><span class="p">,(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">vid_ids</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Google API uses deep learning to identify number of faces, facial expressions and the text contained in the thumbnail image of each youtube video. An example is shown below of the facial recognition. The google vision also accurately identifies any text inside the thunbnail image.</p>
<p><img src="https://github.com/jmmerrell/ws/blob/master/data/youtube_jadoinstuff/output_images/thumbnail_zVRQiZCnKPs.jpg?raw=true" alt="kaggle_img001" /></p>
<p>I combined the YouTube data with the thumbnail image data for each channel, including nearly 100 videos for each channel.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">merre</span><span class="se">\\</span><span class="s2">Desktop</span><span class="se">\\</span><span class="s2">ws</span><span class="se">\\</span><span class="s2">data</span><span class="se">\\</span><span class="s2">youtube_jadoinstuff&quot;</span><span class="p">)</span>

<span class="n">files</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shanieology.txt&quot;</span><span class="p">,</span><span class="s2">&quot;simau.txt&quot;</span><span class="p">,</span><span class="s2">&quot;soundslikepizza.txt&quot;</span><span class="p">,</span><span class="s2">&quot;azerrz.txt&quot;</span><span class="p">,</span><span class="s2">&quot;BigShade.txt&quot;</span><span class="p">,</span><span class="s2">&quot;black_gryph0n.txt&quot;</span>
<span class="p">,</span><span class="s2">&quot;brian_hull.txt&quot;</span><span class="p">,</span><span class="s2">&quot;brizzy_voices.txt&quot;</span><span class="p">,</span><span class="s2">&quot;brock_baker.txt&quot;</span><span class="p">,</span><span class="s2">&quot;charlie_hopkinson.txt&quot;</span><span class="p">,</span><span class="s2">&quot;danny_padilla_&amp;_mason_sperling.txt&quot;</span>
<span class="p">,</span><span class="s2">&quot;ja_doin_stuff.txt&quot;</span><span class="p">,</span><span class="s2">&quot;joshiiwuh.txt&quot;</span><span class="p">,</span><span class="s2">&quot;knep.txt&quot;</span><span class="p">,</span><span class="s2">&quot;ori.txt&quot;</span><span class="p">,</span><span class="s2">&quot;redfireball555.txt&quot;</span><span class="p">,</span><span class="s2">&quot;scheiffer_bates.txt&quot;</span><span class="p">,</span><span class="s2">&quot;daniel_ferguson.txt&quot;</span><span class="p">,</span>
<span class="s2">&quot;BigShade.txt&quot;</span><span class="p">,</span><span class="s2">&quot;best_in_class.txt&quot;</span><span class="p">,</span><span class="s2">&quot;maxamili.txt&quot;</span><span class="p">,</span><span class="s2">&quot;mikey_bolts.txt&quot;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;title_len&#39;</span><span class="p">,</span><span class="s1">&#39;words&#39;</span><span class="p">,</span><span class="s1">&#39;upper_pct&#39;</span><span class="p">,</span><span class="s1">&#39;emoji_count&#39;</span><span class="p">,</span><span class="s1">&#39;upload_date&#39;</span><span class="p">,</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;upload_day&#39;</span><span class="p">,</span><span class="s1">&#39;upload_time_of_day&#39;</span><span class="p">,</span><span class="s1">&#39;viewCount&#39;</span><span class="p">,</span><span class="s1">&#39;likeCount&#39;</span><span class="p">,</span><span class="s1">&#39;dislikeCount&#39;</span><span class="p">,</span><span class="s1">&#39;favoriteCount&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;commentCount&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;definition&#39;</span><span class="p">,</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span><span class="s1">&#39;licensedContent&#39;</span><span class="p">,</span><span class="s1">&#39;thumbnail_url&#39;</span><span class="p">,</span> <span class="s1">&#39;thumbnail_w&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;thumbnail_h&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span><span class="s1">&#39;num_tags&#39;</span><span class="p">,</span><span class="s1">&#39;categoryId&#39;</span><span class="p">,</span><span class="s1">&#39;liveBroadcastContent&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;topicCategories&#39;</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_subs&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_views&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_videos&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span><span class="p">])</span>

<span class="c1">#Loop through all the youtuber&#39;s data files and combine into on data frame </span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	<span class="n">df_add</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
	<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_add</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1">#Read in the files that have the thumbnail data, and combine with the youtuber data</span>
<span class="n">df_thumb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;thumbnail_data_20210801_23-03-21.638854.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;thumbnail_data_20210802_21-39-16.451172.txt&quot;</span><span class="p">))</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;defaultAudioLanguage&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">df_thumb</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;thumbnail_url&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;video_id&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;emoji_count&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;all_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To get an overview of the data, let's check the first rows and the size of the data set. We can see the data has 1,940 rows and 40 columns.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_all</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>video_id</th>
      <th>title</th>
      <th>title_len</th>
      <th>words</th>
      <th>upper_pct</th>
      <th>upload_date</th>
      <th>upload_time</th>
      <th>upload_day</th>
      <th>upload_time_of_day</th>
      <th>viewCount</th>
      <th>...</th>
      <th>desc</th>
      <th>labels</th>
      <th>faces</th>
      <th>texts</th>
      <th>adult</th>
      <th>medical</th>
      <th>racy</th>
      <th>spoof</th>
      <th>violence</th>
      <th>all_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>eyyTBJUKI3c</td>
      <td>Skeletor reacts to Episode 1 of Teela and the ...</td>
      <td>80</td>
      <td>14</td>
      <td>0.000000</td>
      <td>2021-07-25</td>
      <td>11:22:54</td>
      <td>6</td>
      <td>afternoon</td>
      <td>15005</td>
      <td>...</td>
      <td>In this video Skeletor will react and give his...</td>
      <td>['Action figure', 'Animated cartoon', 'Animati...</td>
      <td>[]</td>
      <td>['A', 'AND', 'BAIT', 'R.I.P.', 'SWITCH!', 'THI...</td>
      <td>UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>LIKELY</td>
      <td>UNLIKELY</td>
      <td>Skeletor reacts to Episode 1 of Teela and the ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>S1Bmx8Dti6Y</td>
      <td>Top 5 Worst Reboot Offences Part 2 || Skeletor...</td>
      <td>53</td>
      <td>9</td>
      <td>0.000000</td>
      <td>2021-07-27</td>
      <td>18:40:21</td>
      <td>1</td>
      <td>night</td>
      <td>9497</td>
      <td>...</td>
      <td>In this video Skeletor finishes his top 5 wors...</td>
      <td>['Animated cartoon', 'Animation', 'Art', 'Ente...</td>
      <td>['other', 'other', 'other', 'other', 'other']</td>
      <td>['Stop', 'Stop exploiting\nour nostalgia!\n', ...</td>
      <td>VERY_UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>LIKELY</td>
      <td>UNLIKELY</td>
      <td>Top 5 Worst Reboot Offences Part 2 || Skeletor...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>DStvv0peyYQ</td>
      <td>Top 5 Worst Reboot Offences Part 1 :Skeletor R...</td>
      <td>51</td>
      <td>9</td>
      <td>0.000000</td>
      <td>2021-07-21</td>
      <td>11:03:11</td>
      <td>2</td>
      <td>afternoon</td>
      <td>5312</td>
      <td>...</td>
      <td>In this video Skeletor does a top 5 list of re...</td>
      <td>['Advertising', 'Animated cartoon', 'Animation...</td>
      <td>['other', 'other', 'other', 'other']</td>
      <td>['1', '5', 'Hollywood', 'I', "I wonder why we ...</td>
      <td>UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>LIKELY</td>
      <td>UNLIKELY</td>
      <td>Top 5 Worst Reboot Offences Part 1 :Skeletor R...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PCwtNUQ3t30</td>
      <td>Skeletor Reacts to the new MOTU toy line Pt2 W...</td>
      <td>71</td>
      <td>15</td>
      <td>0.066667</td>
      <td>2021-07-17</td>
      <td>13:34:25</td>
      <td>5</td>
      <td>afternoon</td>
      <td>5079</td>
      <td>...</td>
      <td>This video is part 2 of Skeletor's reaction to...</td>
      <td>['Animated cartoon', 'Animation', 'Art', 'Cart...</td>
      <td>[]</td>
      <td>['ETERNIA', 'No', 'SHORE', 'So...', "So...\nWh...</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>LIKELY</td>
      <td>UNLIKELY</td>
      <td>Skeletor Reacts to the new MOTU toy line Pt2 W...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>yiQto5PfuII</td>
      <td>Skeletor Reacts to Episode 2 of Teela and the ...</td>
      <td>87</td>
      <td>16</td>
      <td>0.000000</td>
      <td>2021-07-31</td>
      <td>12:13:54</td>
      <td>5</td>
      <td>afternoon</td>
      <td>4891</td>
      <td>...</td>
      <td>This video is part one of Skeletor watches and...</td>
      <td>['Animated cartoon', 'Animation', 'Art', 'Elec...</td>
      <td>['other']</td>
      <td>['SOMETHING', 'SOMETHING\nSTINKS!\n', 'STINKS!']</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>POSSIBLE</td>
      <td>UNLIKELY</td>
      <td>Skeletor Reacts to Episode 2 of Teela and the ...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1935</th>
      <td>mCjhGzx3FOA</td>
      <td>Impressions of Famous Authors</td>
      <td>29</td>
      <td>4</td>
      <td>0.000000</td>
      <td>2019-07-22</td>
      <td>13:53:24</td>
      <td>0</td>
      <td>afternoon</td>
      <td>51825</td>
      <td>...</td>
      <td>Go to http://www.audible.com/MIKEYBOLTS or tex...</td>
      <td>['Audio equipment', 'Baseball cap', 'Beard', '...</td>
      <td>['other']</td>
      <td>['AUTHORS', 'FAMOUS', 'FAMOUS\nAUTHORS\n']</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>POSSIBLE</td>
      <td>VERY_UNLIKELY</td>
      <td>Impressions of Famous Authors['Impressions', '...</td>
    </tr>
    <tr>
      <th>1936</th>
      <td>aTm4yI1hbrU</td>
      <td>14 Things That Drive Me Nuts In 2020</td>
      <td>36</td>
      <td>8</td>
      <td>0.000000</td>
      <td>2020-08-25</td>
      <td>15:02:31</td>
      <td>1</td>
      <td>afternoon</td>
      <td>41215</td>
      <td>...</td>
      <td>MAN ITS GOOD TO BE BACK! :) \nThanks for watch...</td>
      <td>['Audio equipment', 'Azure', 'Baseball cap', '...</td>
      <td>['happy']</td>
      <td>['2020', '2020\n']</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>14 Things That Drive Me Nuts In 2020['Impressi...</td>
    </tr>
    <tr>
      <th>1937</th>
      <td>W8cR5YsSo-I</td>
      <td>THE QUARANTINE ANTHEM</td>
      <td>21</td>
      <td>3</td>
      <td>1.000000</td>
      <td>2020-03-27</td>
      <td>18:52:07</td>
      <td>4</td>
      <td>night</td>
      <td>40042</td>
      <td>...</td>
      <td>A song I made about quarantine.\nPls Subscribe...</td>
      <td>['Advertising', 'Brand', 'Cameras &amp; optics', '...</td>
      <td>['other']</td>
      <td>['MUSIC', 'MUSIC VIDEO\n', 'VIDEO']</td>
      <td>UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>UNLIKELY</td>
      <td>VERY_LIKELY</td>
      <td>UNLIKELY</td>
      <td>THE QUARANTINE ANTHEM['corona virus', 'corona ...</td>
    </tr>
    <tr>
      <th>1938</th>
      <td>DmBZ1vjOibM</td>
      <td>IMPRESSIONS CHALLENGE 16 | Mikey Bolts</td>
      <td>38</td>
      <td>5</td>
      <td>0.400000</td>
      <td>2021-04-14</td>
      <td>15:06:16</td>
      <td>2</td>
      <td>afternoon</td>
      <td>33362</td>
      <td>...</td>
      <td>- Hello Fellas &amp; Stella's, Friends, and Marshe...</td>
      <td>['Animated cartoon', 'Audio equipment', 'Baseb...</td>
      <td>['happy', 'happy']</td>
      <td>['00', '00\nIMPRESSIONS\nCHALLENGE\n16\n', '16...</td>
      <td>UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>IMPRESSIONS CHALLENGE 16 | Mikey Bolts['corona...</td>
    </tr>
    <tr>
      <th>1939</th>
      <td>Tyz2Pcp1p5A</td>
      <td>HOTDOG IN A RAINCOAT - Original Animation</td>
      <td>41</td>
      <td>6</td>
      <td>0.666667</td>
      <td>2021-02-22</td>
      <td>14:54:14</td>
      <td>0</td>
      <td>afternoon</td>
      <td>16722</td>
      <td>...</td>
      <td>hello friends. here's something i made. hope y...</td>
      <td>['Animated cartoon', 'Art', 'Brand', 'Cartoon'...</td>
      <td>[]</td>
      <td>['@mikeybolts', 'A', 'A\nDOG\n@mikeybolts\n', ...</td>
      <td>UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>VERY_UNLIKELY</td>
      <td>POSSIBLE</td>
      <td>UNLIKELY</td>
      <td>HOTDOG IN A RAINCOAT - Original Animation['cor...</td>
    </tr>
  </tbody>
</table>
<p>1940 rows Ã— 40 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are 1940 YouTube videos for the analysis and 40 features.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Analyze-and-prepare-the-data">3. Analyze and prepare the data<a class="anchor-link" href="#3.-Analyze-and-prepare-the-data"> </a></h2><p>In the next steps we will create new fields that could potentially be valuable, handle missing values, and determine if any columns should be left out of the study.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.1.-Missing-Values">4.1. Missing Values<a class="anchor-link" href="#4.1.-Missing-Values"> </a></h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>PoolQC          1453
MiscFeature     1406
Alley           1369
Fence           1179
FireplaceQu      690
LotFrontage      259
GarageYrBlt       81
GarageType        81
GarageFinish      81
GarageQual        81
GarageCond        81
BsmtFinType2      38
BsmtExposure      38
BsmtFinType1      37
BsmtCond          37
BsmtQual          37
MasVnrArea         8
MasVnrType         8
Electrical         1
dtype: int64
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some features have missing values counting for the majority of their entries. Checking the <a href="https://www.kaggle.com/c/home-data-for-ml-course/data">competition page</a>, we find more details about the values for each feature, which will help us handle missing data.</p>
<p>For instance, in the columns <code>PoolQC</code>, <code>MiscFeature</code>, <code>Alley</code>, <code>Fence</code>, and <code>FireplaceQu</code>, the missing values mean that the house doesn't count with that specific feature, so, we'll fill the missing values with "NA". All the null values in columns starting with <code>Garage</code> and <code>Bsmt</code> are related to houses that don't have a garage or basement, respectively. We'll fill those and the remaining null values with "NA" or the mean value, considering if the features are categorical or numerical.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.2.-Preprocessing-the-categorical-variables">4.2. Preprocessing the categorical variables<a class="anchor-link" href="#4.2.-Preprocessing-the-categorical-variables"> </a></h3><p>Most machine learning models only work with numerical variables. Therefore, if we feed the model with categorical variables without preprocessing them first, we'll get an error.</p>
<p>There are several ways to deal with categorical values. Here, we'll use <em>One-Hot Encoding</em>, which will create new columns indicating the presence or absence of each value in the original data.</p>
<p>One issue of One-Hot Encoding is dealing with variables with numerous unique categories since it will create a new column for each unique category. Thus, this project will only include categorical variables with no more than 15 unique values.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">categorical_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> 
                   <span class="n">X_train_full</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="ow">and</span>
                   <span class="n">X_train_full</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">]</span>

<span class="c1"># Select numeric values</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                <span class="n">X_train_full</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">]]</span>

<span class="c1"># Keep selected columns</span>
<span class="n">my_columns</span> <span class="o">=</span> <span class="n">categorical_cols</span> <span class="o">+</span> <span class="n">numeric_cols</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="p">[</span><span class="n">my_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_valid</span> <span class="o">=</span> <span class="n">X_valid_full</span><span class="p">[</span><span class="n">my_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test_full</span><span class="p">[</span><span class="n">my_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.3.-Create-a-pipeline">4.3. Create a pipeline<a class="anchor-link" href="#4.3.-Create-a-pipeline"> </a></h3><p><em>Pipelines</em> are a great way to keep the data modeling and preprocessing more organized and easier to understand. Creating a pipeline, we'll handle the missing values and the preprocessing covered in the previous two steps.</p>
<p>As defined above, numerical missing entries will be filled with the mean value while missing categorical variables will be filled with "NA". Furthermore, categorical columns will also be preprocessed with One-Hot Encoding.</p>
<p>We are using <em>SimpleImputer</em> to fill in missing values and <em>ColumnTransformer</em> will help us to apply the numerical and categorical preprocessors in a single transformer.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">numerical_transformer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

<span class="c1"># Preprocessing categorical values</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
                                   <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;NA&#39;</span><span class="p">)),</span>
                                   <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
                                   <span class="p">])</span>

<span class="c1"># Pack the preprocessors together</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
                                 <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numerical_transformer</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_cols</span><span class="p">)</span>
                                 <span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5.-Define-a-model">5. Define a model<a class="anchor-link" href="#5.-Define-a-model"> </a></h2><p>Now that we have bundled our preprocessors in a pipeline, we can define a model. In this article, we are working with <strong>XGBoost</strong>, one of the most effective machine learning algorithms, that presents great results in many Kaggle competitions. As a metric of evaluation, we are using the <strong>Mean Absolute Error</strong>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Pack preprocessing and modeling together in a pipeline</span>
<span class="n">my_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                              <span class="p">])</span>

<span class="c1"># Preprocessing of training data, fit model </span>
<span class="n">my_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Preprocessing of validation data, get predictions</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">my_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE:&#39;</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MAE: 16706.181988441782
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Training-and-validation-data">3. Training and validation data<a class="anchor-link" href="#3.-Training-and-validation-data"> </a></h2><p>It is crucial to break our data into a set for training the model and another one to validate the results. It's worth mentioning that we should never use the test data here. Our test set stays untouched until we are satisfied with our model's performance.</p>
<p>What we're going to do is taking the predictors <strong>X</strong> and target vector <strong>y</strong> and breaking them into training and validation sets. For that, we'll use scikit-learn's <code>train_test_split</code>.</p>
<p>print(f'Shape of X_train_full: {X_train_full.shape}')
print(f'Shape of X_valid_full: {X_valid_full.shape}')
print(f'Shape of y_train: {y_train.shape}')
print(f'Shape of y_valid: {y_valid.shape}')</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="6.-Cross-validation">6. Cross-validation<a class="anchor-link" href="#6.-Cross-validation"> </a></h2><p>Using <a href="https://scikit-learn.org/stable/modules/cross_validation.html#">Cross-Validation</a> can yield better results. Instead of simply using the training and test sets, cross-validation will run our model on different subsets of the data to get multiple measures of model quality.</p>
<p>We'll use the cross-validator <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html">KFold</a> in its default setup to split the training data into 5 folds. Then, each fold will be used once as validation while the remaining folds will form the training set. After that, <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_validate.html">cross-validate</a> will evaluate the metrics. In this case, we're using the Mean Absolute Error.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kfold</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Evaluating the Mean Absolute Error</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">my_pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                              <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_absolute_error&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">)</span>

<span class="c1"># Multiply by -1 since sklearn calculates negative MAE</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average MAE score:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;test_score&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Average MAE score: 16168.894833206665
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With cross-validation we could improve our score, reducing the error. In the next step, we'll try to further improve the model, optimizing some hyperparameters.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="7.-Hyperparameter-tuning">7. Hyperparameter tuning<a class="anchor-link" href="#7.-Hyperparameter-tuning"> </a></h2><p><strong>XGBoost</strong> in its default setup usually yields great results, but it also has plenty of hyperparameters that can be optimized to improve the model. Here, we'll use a method called <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html">GridSearchCV</a> which will search over specified parameter values and return the best ones. Once again, we'll utilize the pipeline and the cross-validator <em>KFold</em> defined above.</p>
<p><em>GridSearchCV</em> will perform an exhaustive search over parameters, which can demand a lot of computational power and take a lot of time to be finished. We can speed up the process a little bit by setting the parameter <code>n_jobs</code> to <code>-1</code>, which means that the machine will use all processors on the task.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">To pass parameter in a pipeline, we should add the names of the steps and the parameter name separated by a â€˜__â€™.</span>
<span class="sd">Ex: Instead of &#39;n_estimators&#39;, we should set &#39;model__n_estimators&#39;.</span>
<span class="sd">https://github.com/scikit-learn/scikit-learn/issues/18472</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># parameters to be searched over</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">],</span>
              <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
              <span class="s1">&#39;model__min_child_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
              <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>

<span class="c1"># find the best parameter</span>
<span class="n">kfold</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">my_pipeline</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_absolute_error&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_result</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best result:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">grid_result</span><span class="o">.</span><span class="n">best_score_</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">grid_result</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best result: 15750.17 for {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 3, &#39;model__min_child_weight&#39;: 0.0001, &#39;model__n_estimators&#39;: 400}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="8.-Generate-test-predictions">8. Generate test predictions<a class="anchor-link" href="#8.-Generate-test-predictions"> </a></h2><p>After tuning some hyperparameters, it's time to go over the modeling process again to make predictions on the test set. We'll define our final model based on the optimized values provided by <em>GridSearchCV</em>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">final_model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> 
                           <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                           <span class="n">min_child_weight</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> 
                           <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                           <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                           <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
                           <span class="p">)</span>

<span class="c1"># Create a pipeline</span>
<span class="n">final_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;final_model&#39;</span><span class="p">,</span> <span class="n">final_model</span><span class="p">)</span>
                                 <span class="p">])</span>

<span class="c1"># Fit the model</span>
<span class="n">final_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Get predictions on the test set</span>
<span class="n">final_prediction</span> <span class="o">=</span> <span class="n">final_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="9.-Submit-your-results">9. Submit your results<a class="anchor-link" href="#9.-Submit-your-results"> </a></h2><p>We're almost there! The machine learning modeling is done, but we still need to submit our results to have our score recorded.</p>
<p>This step is quite simple. We need to create a <code>.csv</code> file containing the predictions. This file consists of a DataFrame with two columns. In this case, one column for "Id" and the other one for the test predictions on the target feature.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                       <span class="s1">&#39;SalePrice&#39;</span><span class="p">:</span> <span class="n">final_prediction</span><span class="p">})</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;submission.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="10.-Join-the-competition">10. Join the competition<a class="anchor-link" href="#10.-Join-the-competition"> </a></h2><p>Finally, we just need to join the competition. Please follow the steps below, according to Kaggle's instructions.</p>
<ul>
<li>Start by accessing the <a href="https://www.kaggle.com/c/home-data-for-ml-course">competition page</a> and clicking on <strong>Join Competition</strong>.</li>
<li>In your Kaggle notebook, click on the blue Save Version button in the top right corner of the window.</li>
<li>A pop-up window will show up. Select the option <strong>Save and Run All</strong> and then click on the blue Save button.</li>
<li>A new pop-up shows up in the bottom left corner while your notebook is running. When it stops running, click on the number to the right of the <strong>Save Version</strong> button. You should click on the <strong>ellipsis (...)</strong> to the right of the most recent notebook version, and select <strong>Open in Viewer</strong>. This brings you into view mode of the same page.</li>
<li>Now, click on the <strong>Output</strong> tab on the right of the screen. Then, click on the blue <strong>Submit</strong> button to submit your results to the leaderboard.</li>
</ul>
<p>After submitting, you can check your score and position on the <a href="https://www.kaggle.com/c/home-data-for-ml-course/leaderboard">leaderboard</a>.</p>
<p><img src="https://github.com/rmpbastos/data_science/blob/master/img/kaggle_img4.jpg?raw=true" alt="kaggle_img004" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h2><p>This article was intended to be instructive, helping data science beginners to structure their first projects on Kaggle in simple steps. With this straightforward approach, I've got a score of <strong>14,778.87</strong>, which ranked this project in the Top 7%.</p>
<p>After further studying, you can go back on past projects and try to enhance their performance, using new skills you've learned. To improve this project, we could investigate and treat the outliers more closely, apply a different approach to missing values, or do some feature engineering, for instance.</p>
<p>My advice to beginners is to keep it simple when starting out. Instead of aiming at the "perfect" model, focus on completing the project, applying your skills correctly, and learning from your mistakes, understanding where and why you messed things up. The data science community is on constant expansion and there's plenty of more experienced folks willing to help on websites like Kaggle or Stack Overflow. Try to learn from their past mistakes as well! With practice and discipline, it's just a matter of time to start building more elaborate projects and climb up the ranking of Kaggle's competitions.</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/ws/2021/07/30/youtube_views_xgboost.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/ws/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/ws/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/ws/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Some data science projects I&#39;m passionate about.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmmerrell" title="jmmerrell"><svg class="svg-icon grey"><use xlink:href="/ws/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.youtube.com/channel/UC_3VPXVC1-ym83R3fOIMpVQ" title="YouTube"><svg class="svg-icon grey"><use xlink:href="/ws/assets/minima-social-icons.svg#youtube"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
